import React, { useState, useRef, useEffect } from 'react';
import Icon from '../../../components/AppIcon';

const ChatbotSection = ({ currentLanguage }) => {
  const [messages, setMessages] = useState([]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);

  const quickQuestions = [
    {
      en: "Where is my money?",
      hi: "рдореЗрд░рд╛ рдкреИрд╕рд╛ рдХрд╣рд╛рдБ рд╣реИ?"
    },
    {
      en: "How much will I earn?",
      hi: "рдореИрдВ рдХрд┐рддрдирд╛ рдХрдорд╛рдКрдВрдЧрд╛?"
    },
    {
      en: "Is my money safe?",
      hi: "рдХреНрдпрд╛ рдореЗрд░рд╛ рдкреИрд╕рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ?"
    },
    {
      en: "How to withdraw?",
      hi: "рдХреИрд╕реЗ рдирд┐рдХрд╛рд▓реЗрдВ?"
    }
  ];

  const initialMessage = {
    id: 1,
    type: 'bot',
    content: {
      en: `Hello! I'm Sikka AI, your investment assistant. I'm here to help you understand investments in simple terms. Ask me anything about your money, investments, or how Sikka works!`,
      hi: `рдирдорд╕реНрддреЗ! рдореИрдВ рд╕рд┐рдХреНрдХрд╛ AI рд╣реВрдБ, рдЖрдкрдХрд╛ рдирд┐рд╡реЗрд╢ рд╕рд╣рд╛рдпрдХред рдореИрдВ рдЖрдкрдХреЛ рд╕рд░рд▓ рд╢рдмреНрджреЛрдВ рдореЗрдВ рдирд┐рд╡реЗрд╢ рд╕рдордЭрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ рд╣реВрдБред рдореБрдЭрд╕реЗ рдЕрдкрдиреЗ рдкреИрд╕реЗ, рдирд┐рд╡реЗрд╢ рдпрд╛ рд╕рд┐рдХреНрдХрд╛ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рднреА рдкреВрдЫреЗрдВ!`
    },
    timestamp: new Date()
  };

  useEffect(() => {
    if (messages?.length === 0) {
      setMessages([initialMessage]);
    }
  }, []);

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const scrollToBottom = () => {
    messagesEndRef?.current?.scrollIntoView({ behavior: "smooth" });
  };

  const handleSendMessage = async (messageText = inputMessage) => {
    if (!messageText?.trim()) return;

    const userMessage = {
      id: Date.now(),
      type: 'user',
      content: messageText,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setInputMessage('');
    setIsTyping(true);

    // Simulate bot response
    setTimeout(() => {
      const botResponse = generateBotResponse(messageText);
      const botMessage = {
        id: Date.now() + 1,
        type: 'bot',
        content: botResponse,
        timestamp: new Date()
      };
      
      setMessages(prev => [...prev, botMessage]);
      setIsTyping(false);
    }, 1500);
  };

  const generateBotResponse = (userMessage) => {
    const lowerMessage = userMessage?.toLowerCase();
    
    if (lowerMessage?.includes('money') || lowerMessage?.includes('рдкреИрд╕рд╛')) {
      return currentLanguage === 'en' 
        ? `Your money is invested in carefully selected ETFs and Mutual Funds. Think of it like this: instead of keeping money in one place, we spread it across many good companies, just like not putting all eggs in one basket! ЁЯеЪ\n\nYour investments are:\nтАв Protected by SEBI regulations\nтАв Managed by professional fund managers\nтАв Diversified across multiple companies\n\nWould you like to see exactly where your тВ╣100 is invested?`
        : `рдЖрдкрдХрд╛ рдкреИрд╕рд╛ рд╕рд╛рд╡рдзрд╛рдиреА рд╕реЗ рдЪреБрдиреЗ рдЧрдП ETF рдФрд░ рдореНрдпреВрдЪреБрдЕрд▓ рдлрдВрдб рдореЗрдВ рдирд┐рд╡реЗрд╢рд┐рдд рд╣реИред рдЗрд╕реЗ рдРрд╕реЗ рд╕рдордЭреЗрдВ: рдкреИрд╕реЗ рдХреЛ рдПрдХ рдЬрдЧрд╣ рд░рдЦрдиреЗ рдХреЗ рдмрдЬрд╛рдп, рд╣рдордиреЗ рдЗрд╕реЗ рдХрдИ рдЕрдЪреНрдЫреА рдХрдВрдкрдирд┐рдпреЛрдВ рдореЗрдВ рдлреИрд▓рд╛рдпрд╛ рд╣реИ, рдЬреИрд╕реЗ рд╕рднреА рдЕрдВрдбреЗ рдПрдХ рдЯреЛрдХрд░реА рдореЗрдВ рди рд░рдЦрдирд╛! ЁЯеЪ\n\nрдЖрдкрдХреЗ рдирд┐рд╡реЗрд╢:\nтАв SEBI рдирд┐рдпрдореЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд\nтАв рдкреЗрд╢реЗрд╡рд░ рдлрдВрдб рдореИрдиреЗрдЬрд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдмрдВрдзрд┐рдд\nтАв рдХрдИ рдХрдВрдкрдирд┐рдпреЛрдВ рдореЗрдВ рд╡рд┐рд╡рд┐рдзреАрдХреГрдд\n\nрдХреНрдпрд╛ рдЖрдк рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреЗ тВ╣100 рдХрд╣рд╛рдБ рдирд┐рд╡реЗрд╢рд┐рдд рд╣реИрдВ?`;
    }
    
    if (lowerMessage?.includes('earn') || lowerMessage?.includes('рдХрдорд╛')) {
      return currentLanguage === 'en'
        ? `Great question! Your earnings depend on market performance, but here's a simple example:\n\nЁЯМ▒ If you invest тВ╣10 daily:\nтАв In 1 year: тВ╣3,650 invested\nтАв Potential growth: тВ╣4,000-4,500 (10-12% returns)\nтАв Your profit: тВ╣350-850\n\nIt's like planting a seed that grows into a tree! The longer you keep it, the bigger it grows. ЁЯМ│\n\nRemember: Past performance doesn't guarantee future results, but historically, good funds have given 10-15% annual returns.`
        : `рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛ рд╕рд╡рд╛рд▓! рдЖрдкрдХреА рдХрдорд╛рдИ рдмрд╛рдЬрд╛рд░ рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣рд╛рдБ рдПрдХ рд╕рд░рд▓ рдЙрджрд╛рд╣рд░рдг рд╣реИ:\n\nЁЯМ▒ рдпрджрд┐ рдЖрдк рд░реЛрдЬ тВ╣10 рдирд┐рд╡реЗрд╢ рдХрд░рддреЗ рд╣реИрдВ:\nтАв 1 рд╕рд╛рд▓ рдореЗрдВ: тВ╣3,650 рдирд┐рд╡реЗрд╢рд┐рдд\nтАв рд╕рдВрднрд╛рд╡рд┐рдд рд╡реГрджреНрдзрд┐: тВ╣4,000-4,500 (10-12% рд░рд┐рдЯрд░реНрди)\nтАв рдЖрдкрдХрд╛ рд▓рд╛рдн: тВ╣350-850\n\nрдпрд╣ рдмреАрдЬ рдмреЛрдиреЗ рдЬреИрд╕рд╛ рд╣реИ рдЬреЛ рдкреЗрдбрд╝ рдмрди рдЬрд╛рддрд╛ рд╣реИ! рдЬрд┐рддрдирд╛ рд▓рдВрдмрд╛ рд░рдЦреЗрдВрдЧреЗ, рдЙрддрдирд╛ рдмрдбрд╝рд╛ рд╣реЛрдЧрд╛ред ЁЯМ│\n\nрдпрд╛рдж рд░рдЦреЗрдВ: рдкрд┐рдЫрд▓рд╛ рдкреНрд░рджрд░реНрд╢рди рднрд╡рд┐рд╖реНрдп рдХреА рдЧрд╛рд░рдВрдЯреА рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд░реВрдк рд╕реЗ рдЕрдЪреНрдЫреЗ рдлрдВрдб рдиреЗ 10-15% рд╡рд╛рд░реНрд╖рд┐рдХ рд░рд┐рдЯрд░реНрди рджрд┐рдпрд╛ рд╣реИред`;
    }
    
    if (lowerMessage?.includes('safe') || lowerMessage?.includes('рд╕реБрд░рдХреНрд╖рд┐рдд')) {
      return currentLanguage === 'en' ? `Yes, your money is safe! Here's why:\n\nЁЯЫбя╕П **Regulatory Protection:**\nтАв SEBI (Securities Exchange Board) regulates all funds\nтАв Your money is held by trustee banks, not by us\nтАв Regular audits and compliance checks\n\nЁЯПж **Fund Safety:**\nтАв Professional fund managers\nтАв Diversified investments (not just one company)\nтАв Transparent reporting\n\nЁЯТб **Think of it like this:**\nIt's like keeping your money in a government-approved bank that invests in many businesses instead of just one.\n\nRisk exists (like any investment), but it's much safer than keeping cash at home!`
        : `рд╣рд╛рдБ, рдЖрдкрдХрд╛ рдкреИрд╕рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ! рдпрд╣рд╛рдБ рдХреНрдпреЛрдВ:\n\nЁЯЫбя╕П **рдирд┐рдпрд╛рдордХ рд╕реБрд░рдХреНрд╖рд╛:**\nтАв SEBI (рд╕рд┐рдХреНрдпреВрд░рд┐рдЯреАрдЬ рдПрдХреНрд╕рдЪреЗрдВрдЬ рдмреЛрд░реНрдб) рд╕рднреА рдлрдВрдб рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ\nтАв рдЖрдкрдХрд╛ рдкреИрд╕рд╛ рдЯреНрд░рд╕реНрдЯреА рдмреИрдВрдХреЛрдВ рдХреЗ рдкрд╛рд╕ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдирд╣реАрдВ\nтАв рдирд┐рдпрдорд┐рдд рдСрдбрд┐рдЯ рдФрд░ рдЕрдиреБрдкрд╛рд▓рди рдЬрд╛рдВрдЪ\n\nЁЯПж **рдлрдВрдб рд╕реБрд░рдХреНрд╖рд╛:**\nтАв рдкреЗрд╢реЗрд╡рд░ рдлрдВрдб рдореИрдиреЗрдЬрд░\nтАв рд╡рд┐рд╡рд┐рдзреАрдХреГрдд рдирд┐рд╡реЗрд╢ (рд╕рд┐рд░реНрдл рдПрдХ рдХрдВрдкрдиреА рдореЗрдВ рдирд╣реАрдВ)\nтАв рдкрд╛рд░рджрд░реНрд╢реА рд░рд┐рдкреЛрд░реНрдЯрд┐рдВрдЧ\n\nЁЯТб **рдЗрд╕реЗ рдРрд╕реЗ рд╕рдордЭреЗрдВ:**\nрдпрд╣ рд╕рд░рдХрд╛рд░ рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрдореЛрджрд┐рдд рдмреИрдВрдХ рдореЗрдВ рдкреИрд╕рд╛ рд░рдЦрдиреЗ рдЬреИрд╕рд╛ рд╣реИ рдЬреЛ рд╕рд┐рд░реНрдл рдПрдХ рдХреЗ рдмрдЬрд╛рдп рдХрдИ рд╡реНрдпрд╡рд╕рд╛рдпреЛрдВ рдореЗрдВ рдирд┐рд╡реЗрд╢ рдХрд░рддрд╛ рд╣реИред\n\nрдЬреЛрдЦрд┐рдо рд╣реИ (рдХрд┐рд╕реА рднреА рдирд┐рд╡реЗрд╢ рдХреА рддрд░рд╣), рд▓реЗрдХрд┐рди рдШрд░ рдореЗрдВ рдирдХрджреА рд░рдЦрдиреЗ рд╕реЗ рдХрд╣реАрдВ рдЬреНрдпрд╛рджрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ!`;
    }
    
    if (lowerMessage?.includes('withdraw') || lowerMessage?.includes('рдирд┐рдХрд╛рд▓')) {
      return currentLanguage === 'en' ? `Withdrawing money is simple! Here's how:\n\nЁЯТ│ **Regular Investments:**\nтАв Go to 'My Portfolio' section\nтАв Select the fund you want to withdraw from\nтАв Choose amount (minimum тВ╣100)\nтАв Money reaches your bank in 1-3 working days\n\nЁЯЪи **Emergency Fund:**\nтАв Instant withdrawal available 24/7\nтАв Money reaches your account in 30 minutes\nтАв No penalties or charges\n\nЁЯУ▒ **Steps:**\n1. Tap 'Withdraw' button\n2. Enter amount\n3. Confirm with OTP\n4. Done!\n\nIt's as easy as withdrawing from an ATM! ЁЯПз`
        : `рдкреИрд╕рд╛ рдирд┐рдХрд╛рд▓рдирд╛ рдЖрд╕рд╛рди рд╣реИ! рдпрд╣рд╛рдБ рдХреИрд╕реЗ:\n\nЁЯТ│ **рдирд┐рдпрдорд┐рдд рдирд┐рд╡реЗрд╢:**\nтАв 'рдореЗрд░рд╛ рдкреЛрд░реНрдЯрдлреЛрд▓рд┐рдпреЛ' рд╕реЗрдХреНрд╢рди рдореЗрдВ рдЬрд╛рдПрдВ\nтАв рдЬрд┐рд╕ рдлрдВрдб рд╕реЗ рдирд┐рдХрд╛рд▓рдирд╛ рд╣реИ рдЙрд╕реЗ рдЪреБрдиреЗрдВ\nтАв рд░рд╛рд╢рд┐ рдЪреБрдиреЗрдВ (рдиреНрдпреВрдирддрдо тВ╣100)\nтАв 1-3 рдХрд╛рд░реНрдп рджрд┐рд╡рд╕реЛрдВ рдореЗрдВ рдкреИрд╕рд╛ рдЖрдкрдХреЗ рдмреИрдВрдХ рдореЗрдВ рдкрд╣реБрдВрдЪ рдЬрд╛рддрд╛ рд╣реИ\n\nЁЯЪи **рдЖрдкрд╛рддрдХрд╛рд▓реАрди рдлрдВрдб:**\nтАв 24/7 рддреБрд░рдВрдд рдирд┐рдХрд╛рд╕реА рдЙрдкрд▓рдмреНрдз\nтАв 30 рдорд┐рдирдЯ рдореЗрдВ рдкреИрд╕рд╛ рдЖрдкрдХреЗ рдЦрд╛рддреЗ рдореЗрдВ\nтАв рдХреЛрдИ рдЬреБрд░реНрдорд╛рдирд╛ рдпрд╛ рд╢реБрд▓реНрдХ рдирд╣реАрдВ\n\nЁЯУ▒ **рдЪрд░рдг:**\n1. 'рдирд┐рдХрд╛рд▓реЗрдВ' рдмрдЯрди рджрдмрд╛рдПрдВ\n2. рд░рд╛рд╢рд┐ рджрд░реНрдЬ рдХрд░реЗрдВ\n3. OTP рд╕реЗ рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВ\n4. рд╣реЛ рдЧрдпрд╛!\n\nрдпрд╣ ATM рд╕реЗ рдкреИрд╕рд╛ рдирд┐рдХрд╛рд▓рдиреЗ рдЬрд┐рддрдирд╛ рдЖрд╕рд╛рди рд╣реИ! ЁЯПз`;
    }
    
    // Default response
    return currentLanguage === 'en' ? `I understand you're asking about investments. Let me help you with that!\n\nI can explain:\nтАв Where your money goes when you invest\nтАв How much you might earn\nтАв Safety of your investments\nтАв How to withdraw money\nтАв Investment basics in simple terms\n\nWhat specific topic would you like to know more about? You can also use the quick questions below! ЁЯШК`
      : `рдореИрдВ рд╕рдордЭ рдЧрдпрд╛ рдХрд┐ рдЖрдк рдирд┐рд╡реЗрд╢ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрдЫ рд░рд╣реЗ рд╣реИрдВред рдореИрдВ рдЖрдкрдХреА рдорджрдж рдХрд░рддрд╛ рд╣реВрдБ!\n\nрдореИрдВ рд╕рдордЭрд╛ рд╕рдХрддрд╛ рд╣реВрдБ:\nтАв рдирд┐рд╡реЗрд╢ рдХрд░рдиреЗ рдкрд░ рдЖрдкрдХрд╛ рдкреИрд╕рд╛ рдХрд╣рд╛рдБ рдЬрд╛рддрд╛ рд╣реИ\nтАв рдЖрдк рдХрд┐рддрдирд╛ рдХрдорд╛ рд╕рдХрддреЗ рд╣реИрдВ\nтАв рдЖрдкрдХреЗ рдирд┐рд╡реЗрд╢ рдХреА рд╕реБрд░рдХреНрд╖рд╛\nтАв рдкреИрд╕рд╛ рдХреИрд╕реЗ рдирд┐рдХрд╛рд▓реЗрдВ\nтАв рд╕рд░рд▓ рд╢рдмреНрджреЛрдВ рдореЗрдВ рдирд┐рд╡реЗрд╢ рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ\n\nрдЖрдк рдХрд┐рд╕ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡рд┐рд╖рдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдЖрдк рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рддреНрд╡рд░рд┐рдд рдкреНрд░рд╢реНрди рднреА рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ! ЁЯШК`;
  };

  const handleQuickQuestion = (question) => {
    handleSendMessage(question?.[currentLanguage]);
  };

  return (
    <div className="flex flex-col h-[600px] bg-card rounded-lg border border-border">
      {/* Chat Header */}
      <div className="flex items-center space-x-3 p-4 border-b border-border">
        <div className="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
          <Icon name="Bot" size={20} className="text-primary-foreground" />
        </div>
        <div>
          <h3 className="font-semibold text-foreground">
            {currentLanguage === 'en' ? 'Sikka AI Assistant' : 'рд╕рд┐рдХреНрдХрд╛ AI рд╕рд╣рд╛рдпрдХ'}
          </h3>
          <p className="text-xs text-success">
            {currentLanguage === 'en' ? 'Online' : 'рдСрдирд▓рд╛рдЗрди'}
          </p>
        </div>
      </div>
      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages?.map((message) => (
          <div
            key={message?.id}
            className={`flex ${message?.type === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div
              className={`max-w-[80%] p-3 rounded-lg ${
                message?.type === 'user' ?'bg-primary text-primary-foreground' :'bg-muted text-foreground'
              }`}
            >
              <p className="text-sm whitespace-pre-line">
                {typeof message?.content === 'object' 
                  ? message?.content?.[currentLanguage] 
                  : message?.content
                }
              </p>
              <p className="text-xs opacity-70 mt-1">
                {message?.timestamp?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
              </p>
            </div>
          </div>
        ))}
        
        {isTyping && (
          <div className="flex justify-start">
            <div className="bg-muted text-foreground p-3 rounded-lg">
              <div className="flex space-x-1">
                <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce"></div>
                <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                <div className="w-2 h-2 bg-muted-foreground rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>
      {/* Quick Questions */}
      <div className="p-4 border-t border-border">
        <div className="flex flex-wrap gap-2 mb-4">
          {quickQuestions?.map((question, index) => (
            <button
              key={index}
              onClick={() => handleQuickQuestion(question)}
              className="px-3 py-2 bg-muted hover:bg-muted/80 text-muted-foreground hover:text-foreground rounded-full text-xs transition-colors duration-200"
            >
              {question?.[currentLanguage]}
            </button>
          ))}
        </div>

        {/* Message Input */}
        <div className="flex space-x-2">
          <input
            type="text"
            value={inputMessage}
            onChange={(e) => setInputMessage(e?.target?.value)}
            onKeyPress={(e) => e?.key === 'Enter' && handleSendMessage()}
            placeholder={currentLanguage === 'en' ? 'Ask me anything about investments...' : 'рдирд┐рд╡реЗрд╢ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рднреА рдкреВрдЫреЗрдВ...'}
            className="flex-1 px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
          />
          <button
            onClick={() => handleSendMessage()}
            disabled={!inputMessage?.trim()}
            className="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200"
          >
            <Icon name="Send" size={16} />
          </button>
        </div>
      </div>
    </div>
  );
};

export default ChatbotSection;